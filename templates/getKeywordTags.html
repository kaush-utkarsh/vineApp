<html>

<head>
    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <script type="text/javascript" src="static/js/jquery-latest.js"></script>
    <script type="text/javascript" src="static/js/jquery.tablesorter.js"></script>
    <link rel="stylesheet" href="static/css/bootstrap.css" />
    <link rel="stylesheet" href="static/css/bootstrap-responsive.css" />
    <link rel="stylesheet" href="static/css/bootstrap.min.css" />
    <link rel="stylesheet" href="static/css/loader.css" />

    <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
    <script>
    $(document).ready(function() {
        $('#loading').css("display", "none");
    });
    </script>
    <script>
    var tot_videos = 0;
    var page_no = 1;
    var starting_tag_page = {};

    function fixSerialNumber() {
        var $rows = $("#tagsTable tr");
        var cnt = 1;
        for (var j = 1; j < $rows.length; j++) {
            if ($rows.eq(j).css("display") != "none") {
                $rows.eq(j).find('td:eq(0)').html('<font size="+2">' + cnt + '</font>');
                cnt += 1;
            }
        }
    }

    function validateVideos() {
        pauseVideos();
        var $rows = $("#tagsTable tr");

        for (var j = 1; j < $rows.length; j++) {
            $rows.eq(j).hide();
            if ($rows.eq(j).find('td:eq(1) input[type=checkbox]').attr('checked'))
                $rows.eq(j).show();
        }
        fixSerialNumber();
        $("#val_video").hide();
        $("#save_video").show();
        $("#next_page").hide();
        $("#previous_page").hide();
        $("#refresh_video").show();
        $("#back").show();
    }

    function toggleCheckbox(elem, serial) {}

    function backClick() {
        pauseVideos();
        var $rows = $("#tagsTable tr");
        showPage();
        fixSerialNumber();
        $("#val_video").show();
        $("#save_video").hide();
        $("#refresh_video").hide();
        $("#back").hide();
        $("#next_page").show();
        if (page_no > 1)
            $("#previous_page").show();
    }

    function showPage() {
        var $rows = $("#tagsTable tr");
        $rows.slice(1).hide()
        var stp = starting_tag_page[$("#keyword").val()];
        for (var i = stp + (tot_videos * (page_no - 1)); i <= stp + (page_no * tot_videos) - 1; i++) {
            $rows.eq(i).show();
        }
    }

    function unCheckSelectedVideos() {
        var $rows = $("#tagsTable tr");
        for (var j = 1; j < $rows.length; j++) {
            $rows.eq(j).find('td:eq(1) input[type=checkbox]').removeAttr('checked');
        }
    }

    function previousPage() {
        pauseVideos();
        //var $rows = $("#tagsTable tr");
        //for(var i=1; i<$rows.length; i++){
        //  $rows.eq(i).hide();
        //}
        page_no -= 1;
        //for(var i=(tot_videos*(page_no-1))+1; i<=(page_no*tot_videos); i++){
        //  $rows.eq(i).show();
        //
        showPage(); //}
        fixSerialNumber();
        if (page_no == 1)
            $("#previous_page").hide();
        $("#previous_page").text("Go to page " + (page_no - 1))
        $("#next_page").text("Go to page " + (page_no + 1));
    }

    function saveSelectedData() {
        pauseVideos();
        var values = new Array();
        $.each($("input[name='case[]']:checked"),
            function() {
                value = $(this).val() + ",:" + $('#prefix').val() + ",:" + $('#standard').val()
                values.push(value);
            });

        values = values.join(";;;")
        //clear the Table
        //      $('#tagsTable tbody').remove();
        $.get('saveUserChoices?choices=' + values);
        alert("Your playlist has been saved, and will be downloaded on the machine. You can resume editing the list.");
    }

    var current_page = 1;

    function updateTablePage(url) {
        pauseVideos();
        var $rows = $("#tagsTable tr");
        for (var i = 1; i < $rows.length; i++) {
            $rows.eq(i).hide();
        }
        page_no += 1;
        var yn = 0;
        var stp = starting_tag_page[$("#keyword").val()];
        for (var i = stp + (tot_videos * (page_no - 1)); i <= stp + (page_no * tot_videos) - 1; i++) {
            if ($rows.eq(i).length > 0)
                yn += 1;
            $rows.eq(i).show();
        }
        fixSerialNumber();
        page_no -= 1;

        var tmp = page_no + 1;
        if (yn <= 1)
            updateTable(url, false);
        $("#next_page").text("Go to page " + (tmp + 1));
        page_no = tmp;
        if (page_no >= 2) {
            $("#previous_page").show();
            $("#previous_page").text("Go to page " + (tmp - 1));
        }
    }

    function pauseVideos() {
        var videos = $("video");
        for (var i = 0; i < videos.length; i++) {
            videos[i].pause();
        }
    }


    function updateTable(url, is_new_query) {
        $("#val_video").show();
        $("#next_page").show();
        $("#save_video").hide();
        $("#previous_page").hide();
        $("#refresh_video").hide();
        $("#back").hide();
        $("#uncheck_videos").show();
        var options
        var txtStrng = '';
        page_no = 1;
        $("#next_page").text("Go to page " + (page_no + 1));
        //grab ajax data
        tot_videos = 0;
        for (var i = 1; i < $("#tagsTable tr").length; i++) {
            $("#tagsTable tr").eq(i).hide();
        }

        $("#loading").show();
        var search_site = $("#search-site").val();
        $.ajax({
            //async: true,
            url: url + "?keyword=" + $('#keyword').val() + "&site=" + search_site,
            dataType: 'json',
            success: function(data, textStatus, jqXHR) {
                if(data.length < {{ data.video_limit }}){
                    $("#next_page").hide();
                } else {
                    $("#next_page").show();
                }
                $.each(data, function(idx, obj) {
                    //val = "'" + obj.full_name + "','"+obj.tag_url + "'";
                    val = "{{ data.username }}" + ",:" + $('#keyword').val() + ",:" + obj.tag_url + ",:" + obj.profile_picture + ",:" + obj.full_name + ",:" + obj.created_time + ",:" + obj.id + ",:" + search_site + ",:" + escape(obj.text);
                    txtStrng += "<tr>";
                    txtStrng += "<td><center><font size=\"+2\">" + obj.serial_no + "</font></center></td>";
                    txtStrng += "<td><center><input type=\"checkbox\"  name=\"case[]\" value = \"" + val + "\" onchange=\"toggleCheckbox(this, '" + obj.id + "')\"></center></td>";
                    txtStrng += "<td><video height=\"150\" width=\"150\" controls><source src=  " + obj.tag_url + " type=video/mp4></video></td>";
                    txtStrng += "<td style=\"word-wrap:break-word;\"><img height=100 width=100 src=" + obj.profile_picture + "> <br>" + obj.full_name + "</td>";
                    txtStrng += "<td style=\"font-size:14;\">" + obj.created_time + "</td>";
                    txtStrng += "<td style=\"word-wrap:break-word;\">" + obj.text + " <a target=\"_blank\" href=\"" + obj.tag_url + "\"><b>Play Full Screen</b></a></td>";
                    txtStrng += "<td style=\"word-wrap:break-word;\">" + $('#keyword').val() + "<br>(" + search_site + ")</td>";
                    txtStrng += "</tr>";
                    tot_videos += 1;
                });
                if (is_new_query) {
                    starting_tag_page[$("#keyword").val()] = $("#tagsTable tr").length;
                }
                $(txtStrng).appendTo('#tagsTable');
            },
            complete: function() {
                $('#loading').hide();
                var tableOffset = $("#tagsTable").offset().top;
                var $header = $("#tagsTable > thead").clone();
                var $fixedHeader = $("#header-fixed").html($header);

                $(window).bind("scroll", function() {
                    var offset = $(this).scrollTop();
                    if (offset >= 50 && $fixedHeader.is(":hidden")) {
                        $("#header-fixed").show();
                    } else if (offset < 50) {
                        $fixedHeader.hide();
                    }
                });

            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log(errorThrown)
            }
        });
    }
    </script>
</head>

<body>
    <div class="navbar-collapse collapse">
    </div>
    <div class="container">
        <div style="position:fixed;z-index:1000;background-color:#fffff8;width:1200px">
            <div class="row text-center">
                <a href="/signup">
                    <img src="/static/logo.gif">
                </a>
            </div>
            <div class="row">
                <ul class="nav navbar-nav navbar-right" style="margin-right:10px;">
                    <li><a href={{ url_for( 'logout') }}>Logout</a>
                    </li>
                </ul>
                <h4 style="text-align:center;">INSTAGRAM ENTER <b>KEYWORD</b> OR <b>USERID</b>
                </h4>
                <form id="input_form" class="form-search" style="text-align:center;">
                    <input type="text" class="input-medium search-query" id="keyword">
                    <select id="search-site" style="align-self: right">
                        <option value="instagram">Instagram</option>
                        <option value="vine">Vine</option>
                    </select>
                    <button id="search_button" type="button" onclick="updateTable('/getKeywordMedia', true)" class="btn">Search</button>
                    <input type="text" placeholder="prefix" style="align-self: right" id="prefix">
                    <select id="standard" style="align-self: right">
                        <option value="29.97">1080i_29.97_MJPEG</option>
                        <option value="59.94">720p_59.94_MJPEG</option>
                    </select>
                </form>

            </div>
            <div class="row">
                <div class="span12" style="margin-bottom:10px;">
                    <button type="button" onclick="validateVideos()" class="btn" style="text-align:center;display:none;" id="val_video">Add to Shortlist</button>
                    <button type="button" onclick="previousPage()" class="btn" style="display:none;" id="previous_page">Previous page &lt;</button>
                    <button type="button" onclick="updateTablePage('/getMoreVideos')" class="btn" style="display:none;" id="next_page">Next page &gt;</button>

                    <button type="button" onclick="unCheckSelectedVideos()" class="btn" style="text-align:center;display:none;" id="uncheck_videos">Uncheck All</button>
                    <button type="button" onclick="saveSelectedData()" class="btn" style="text-align:center;display:none;" id="save_video">Download</button>
                    <button type="button" onclick="validateVideos()" class="btn" style="text-align:center;display:none;" id="refresh_video">Refresh</button>
                    <button type="button" onclick="backClick()" class="btn" style="text-align:center;display:none;" id="back">Back</button>
                </div>
            </div>
        </div>
        <div class="row" style="top:160px;position:absolute">
            <div class="span12">
                <h2 class="sub-header"></h2>
                <form class="form-search">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-condensed tablesorter" id="tagsTable" style="width:1172px;table-layout:fixed;">
                            <thead style="width:1172px;">
                                <tr>
                                    <th width=36>&nbsp;</th>
                                    <th width="60">Select</th>
                                    <th width="160">Video</th>
                                    <th width="119">User</th>
                                    <th width="82">Created Time</th>
                                    <th width="635">Text</th>
                                    <th>Tag</th>
                                </tr>
                            </thead>
                            <tbody style="width:1172px;">
                            </tbody>
                        </table>
                        <div class="loader" id="loading">
                            <center>
                                <img src="static/logo.gif">
                            </center>
                        </div>
                        <table id="header-fixed" class="table table-striped table-bordered table-condensed tablesorter" style="width:1172px;"></table>
                </form>
                </div>
            </div>
        </div>
        <script>
        $("#keyword").keyup(function(event) {
            if (event.keyCode == 13) {
                updateTable('getKeywordMedia', true);
            }
        });
        $("#search_button").keyup(function(event) {
            if (event.keyCode == 13) {
                updateTable('getKeywordMedia', true);
            }
        });
        $('#input_form').bind("keyup keypress", function(e) {
            var code = e.keyCode || e.which;
            if (code == 13) {
                e.preventDefault();
                return false;
            }
        });
        </script>
</body>

</html>
